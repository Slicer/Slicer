name: Pre-commit auto-update

on:
  # every day at midnight
  schedule:
    - cron: "0 0 * * *"
  # on demand
  workflow_dispatch:

permissions:
  contents: read

jobs:
  auto-update:
    permissions:
      # Needed for peter-evans/create-pull-request to create branch
      contents: write
      # Needed for peter-evans/create-pull-request to create a PR
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - uses: actions/create-github-app-token@f2acddfb5195534d487896a656232b016a682f3c # v1.9.0
        id: app-token
        with:
          app-id: ${{ vars.SLICER_APP_ID }}
          private-key: ${{ secrets.SLICER_APP_PRIVATE_KEY }}

      - uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: 3.12

      - run: pip install pre-commit

      - name: pre-commit autoupdate
        run: |
          # To ensure the output only contain lines like the following:
          #  `Updating https://github.com/org/user ... updating v1.2.3 -> v1.2.4`
          # without interleaved string like the following:
          #  `[INFO] Initializing environment for https://github.com/org/user.`
          # we perform the autoupdate twice. This ensures the second run can easily be parsed.
          pre-commit autoupdate --config .pre-commit-config.yaml > /dev/null 2>&1
          git checkout -- .pre-commit-config.yaml
          pre-commit autoupdate --config .pre-commit-config.yaml | tee /tmp/pre-commit-autoupdate.log

      - name: Save parse-autoupdate.py
        run: |
          cat <<EOF >> /tmp/parse-autoupdate.py
          import re
          import sys

          for line in sys.stdin:
              match = re.match(r"\[https://github.com/([^/]+/[^/]+)\] updating (v[\d.]+) -> (v[\d.]+)\.", line.strip())
              if match:
                  repo_url = match.group(1)
                  old_version = match.group(2)
                  new_version = match.group(3)
                  repo_name = repo_url.split('/')[-1]
                  print(f"- [{repo_url}: {old_version} -> {new_version}](pre-commit/{repo_name}@{old_version}...{new_version})")
          EOF

      - name: Parse autoupdate output
        id: parse-autoupdate
        run: |
          {
            echo 'AUTOUPDATE_LOG<<EOF'
            echo "updates:"
            cat /tmp/pre-commit-autoupdate.log | python /tmp/parse-autoupdate.py
            echo EOF
          } >> "$GITHUB_OUTPUT"
        shell: bash

      - uses: peter-evans/create-pull-request@a4f52f8033a6168103c2538976c07b467e8163bc # v6.0.1
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: |
            ENH: Update pre-commit hooks

            ${{ steps.parse-autoupdate.outputs.AUTOUPDATE_LOG }}
          committer: slicer-app[bot] <163601113+slicer-app[bot]@users.noreply.github.com>
          author: slicer-app[bot] <163601113+slicer-app[bot]@users.noreply.github.com>
          signoff: false
          branch: update/pre-commit-hooks
          delete-branch: true
          title: "ENH: Update pre-commit hooks"
          body: |
            <!--pre-commit autoupdate log start-->
            ${{ steps.parse-autoupdate.outputs.AUTOUPDATE_LOG }}
            <!--pre-commit autoupdate log start-->

            This pull-request was auto-generated by the [pre-commit-autoupdate][1] GitHub action workflow.

            [1]: https://github.com/${{ github.repository }}/blob/${{ steps.head_branch.outputs.sha }}/.github/workflows/pre-commit-autoupdate.yml
          draft: false
